

<script>
src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"
src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"
/* =======================
   Firebase Init
======================= */
const firebaseConfig = {
  apiKey: "AIzaSyD9TWP_zvIbGQuOyjtE6aliFIfBx23wdyY",
  authDomain: "changelogs-website.firebaseapp.com",
  projectId: "changelogs-website",
  storageBucket: "changelogs-website.firebasestorage.app",
  messagingSenderId: "98095071875",
  appId: "1:98095071875:web:98d7816bb0549349bf11b6",
  measurementId: "G-RRZ06NSB0G"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const changelogRef = db.ref("uog_changelogs");

/* =======================
   Admin Logic
======================= */
let isAdmin = false;

/* SHA-256 hash of "ERRORNOTLOGGEDINNCETRY" */
const ADMIN_HASH =
"0cd189c90f1d2420cea81ec6f2aec5dcf99bd152d874e3e5b0590a387b62c67a";

function toggleTheme() {
    document.body.classList.toggle("light");
}

async function hashPassword(text) {
    const enc = new TextEncoder().encode(text);
    const hashBuffer = await crypto.subtle.digest("SHA-256", enc);
    return [...new Uint8Array(hashBuffer)]
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
}

async function checkPassword() {
    const input = document.getElementById("passwordInput").value;
    const hashed = await hashPassword(input);

    if (hashed === ADMIN_HASH) {
        isAdmin = true;
        document.getElementById("adminPanel").style.display = "block";
        document.getElementById("passwordBox").style.display = "none";
        document.querySelectorAll(".deleteBtn").forEach(b => {
            b.style.display = "inline-block";
        });
    } else {
        alert("Wrong password");
    }
}

/* =======================
   Changelog Logic
======================= */
function renderChangelog(version, changes) {
    const id = "v" + version.replace(/\./g, "");

    const block = document.createElement("details");
    block.id = id;
    block.setAttribute("data-version", version);

    const summary = document.createElement("summary");
    summary.textContent = "Version " + version;

    const ul = document.createElement("ul");
    changes.forEach(c => {
        const li = document.createElement("li");
        li.textContent = c;
        ul.appendChild(li);
    });

    const del = document.createElement("button");
    del.className = "deleteBtn";
    del.textContent = "Delete Changelog";
    del.style.display = isAdmin ? "inline-block" : "none";
    del.onclick = () => {
        block.remove();
        document.getElementById(id + "_link")?.remove();
        saveChangelogs();
    };

    block.appendChild(summary);
    block.appendChild(ul);
    block.appendChild(del);
    document.getElementById("changelogs").appendChild(block);

    const link = document.createElement("a");
    link.href = "#" + id;
    link.id = id + "_link";
    link.textContent = "Version " + version;
    document.getElementById("sidebarLinks").appendChild(link);
}

function saveChangelogs() {
    const blocks = document.querySelectorAll("#changelogs details");
    const data = [];

    blocks.forEach(block => {
        const version = block.getAttribute("data-version");
        const items = [...block.querySelectorAll("li")].map(li => li.textContent);
        data.push({ version, changes: items });
    });

    changelogRef.set(data);
}

function addChangelog() {
    const version = document.getElementById("versionInput").value;
    const changes = document
        .getElementById("changesInput")
        .value.split("\n")
        .filter(x => x.trim() !== "");

    if (!version || changes.length === 0) {
        alert("Fill in all fields");
        return;
    }

    renderChangelog(version, changes);
    saveChangelogs();

    document.getElementById("versionInput").value = "";
    document.getElementById("changesInput").value = "";
}

/* =======================
   Load + Migrate (SAFE)
======================= */
function loadChangelogs() {
    changelogRef.once("value", snapshot => {
        const remote = snapshot.val();

        if (!remote) {
            // Firebase empty â†’ migrate localStorage
            const local = JSON.parse(localStorage.getItem("uog_changelogs")) || [];
            if (local.length > 0) {
                changelogRef.set(local);
                local.forEach(e => renderChangelog(e.version, e.changes));
            }
            return;
        }

        remote.forEach(e => renderChangelog(e.version, e.changes));
    });
}

/* =======================
   Live Sync (Global)
======================= */
changelogRef.on("value", snapshot => {
    document.getElementById("changelogs").innerHTML = "";
    document.getElementById("sidebarLinks").innerHTML = "";

    const data = snapshot.val();
    if (!data) return;

    data.forEach(e => renderChangelog(e.version, e.changes));
});

loadChangelogs();
</script>
