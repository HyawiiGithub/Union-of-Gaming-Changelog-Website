<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>UOG Changelog</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
  --bg:#0d0d0d; --text:#e6e6e6; --card:#1a1a1a; --accent:#4da6ff;
}
body {
  margin:0; font-family:Segoe UI,sans-serif;
  background:var(--bg); color:var(--text); display:flex;
}
.sidebar {
  width:240px; background:#111; padding:20px;
  position:fixed; height:100vh; overflow:auto;
}
.content { margin-left:260px; padding:40px; width:100%; }
details { background:var(--card); margin-bottom:20px; padding:15px; }
summary { color:var(--accent); font-size:1.2rem; cursor:pointer; }
button,input,textarea {
  width:100%; margin-top:10px; padding:10px;
  background:#000; color:#fff; border:1px solid #444;
}
.deleteBtn { background:#ff4444; display:none; }
#loginPanel {
  position:fixed; top:20px; right:20px; width:260px;
  background:var(--card); padding:15px; border:2px solid var(--accent);
  z-index:9999;
}
#bannedScreen {
  display:none; position:fixed; inset:0;
  background:black; color:red; font-size:2rem;
  display:flex; align-items:center; justify-content:center;
  z-index:10000;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>

<div id="bannedScreen">YOU ARE BANNED FROM THIS SITE</div>

<div class="sidebar">
  <h2>UOG Menu</h2>
  <div id="sidebarLinks"></div>
</div>

<div class="content">

<div id="loginPanel">
  <h3>Login</h3>
  <input id="loginUser" placeholder="Username">
  <input id="loginPass" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <button onclick="register()">Register</button>
</div>

<h1>Union of Gaming Mod</h1>
<div id="changelogs"></div>

<div id="suggestionBox" style="display:none">
  <h3>Suggestions</h3>
  <textarea id="suggestionText"></textarea>
  <button onclick="submitSuggestion()">Submit</button>
</div>

<div id="adminPanel" style="display:none">
  <h3>Add Changelog</h3>
  <input id="versionInput">
  <textarea id="changesInput"></textarea>
  <button onclick="addChangelog()">Add</button>

  <h3>Suggestions</h3>
  <ul id="suggestionList"></ul>

  <h3>Audit Logs</h3>
  <ul id="auditList"></ul>
</div>

</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyD9TWP_zvIbGQuOyjtE6aliFIfBx23wdyY",
  authDomain:"changelogs-website.firebaseapp.com",
  projectId:"changelogs-website",
  storageBucket:"changelogs-website.firebasestorage.app",
  messagingSenderId:"98095071875",
  appId:"1:98095071875:web:98d7816bb0549349bf11b6"
});

const db = firebase.database();
const usersRef = db.ref("users");
const changelogRef = db.ref("uog_changelogs");
const suggestionsRef = db.ref("suggestions");
const auditRef = db.ref("audit_logs");

/* ================= GLOBAL STATE ================= */
let currentUser = null;
let isAdmin = false;

const ADMIN_HASH =
"0cd189c90f1d2420cea81ec6f2aec5dcf99bd152d874e3e5b0590a387b62c67a";

/* ================= UTIL ================= */
async function hashPassword(t){
  const b = await crypto.subtle.digest("SHA-256",new TextEncoder().encode(t));
  return [...new Uint8Array(b)].map(x=>x.toString(16).padStart(2,"0")).join("");
}

function logAudit(action, target=""){
  auditRef.push({
    user: currentUser || "SYSTEM",
    action, target,
    time: new Date().toISOString()
  });
}

/* ================= AUTH ================= */
async function login(){
  const u=loginUser.value.trim(), p=loginPass.value;
  const h=await hashPassword(p);
  usersRef.child(u).once("value",s=>{
    const d=s.val();
    if(!d) return alert("No user");
    if(d.banned){ bannedScreen.style.display="flex"; document.body.innerHTML=""; return; }
    if(d.password!==h) return alert("Wrong password");
    currentUser=u; isAdmin=d.role==="admin";
    loginPanel.style.display="none";
    suggestionBox.style.display="block";
    loadChangelogs();
    if(isAdmin){ adminPanel.style.display="block"; loadSuggestions(); loadAudits(); }
    logAudit("login");
  });
}

async function register(){
  const u=loginUser.value.trim(), p=loginPass.value;
  const h=await hashPassword(p);
  usersRef.child(u).once("value",s=>{
    if(s.exists()) return alert("Exists");
    usersRef.child(u).set({password:h,role:"user",banned:false});
    logAudit("register",u);
    alert("Registered. Login.");
  });
}

/* ================= CHANGELOGS ================= */
function renderChangelog(v,c){
  const d=document.createElement("details");
  d.innerHTML="<summary>Version "+v+"</summary>";
  const ul=document.createElement("ul");
  c.forEach(x=>{ const li=document.createElement("li"); li.textContent=x; ul.appendChild(li);});
  d.appendChild(ul);
  if(isAdmin){
    const b=document.createElement("button");
    b.textContent="Delete"; b.className="deleteBtn";
    b.onclick=()=>{ d.remove(); saveChangelogs(); logAudit("delete_changelog",v); };
    b.style.display="block"; d.appendChild(b);
  }
  changelogs.appendChild(d);
}

function saveChangelogs(){
  const data=[...document.querySelectorAll("#changelogs details")].map(d=>({
    version:d.querySelector("summary").textContent.replace("Version ",""),
    changes:[...d.querySelectorAll("li")].map(li=>li.textContent)
  }));
  changelogRef.set(data);
}

function addChangelog(){
  renderChangelog(versionInput.value,changesInput.value.split("\n"));
  saveChangelogs();
  logAudit("add_changelog",versionInput.value);
}

function loadChangelogs(){
  changelogRef.on("value",s=>{
    changelogs.innerHTML="";
    s.val()?.forEach(e=>renderChangelog(e.version,e.changes));
  });
}

/* ================= SUGGESTIONS ================= */
function submitSuggestion(){
  suggestionsRef.push({user:currentUser,text:suggestionText.value});
  logAudit("suggestion",suggestionText.value);
  suggestionText.value="";
}

function loadSuggestions(){
  suggestionsRef.on("value",s=>{
    suggestionList.innerHTML="";
    s.forEach(x=>{
      const d=x.val();
      const li=document.createElement("li");
      li.innerHTML=`<b>${d.user}</b>: ${d.text}
      <button onclick="banUser('${d.user}')">Ban</button>`;
      suggestionList.appendChild(li);
    });
  });
}

/* ================= BAN ================= */
function banUser(u){
  usersRef.child(u).update({banned:true});
  logAudit("ban",u);
}

/* ================= AUDIT LOGS ================= */
function loadAudits(){
  auditRef.limitToLast(50).on("value",s=>{
    auditList.innerHTML="";
    s.forEach(x=>{
      const d=x.val();
      const li=document.createElement("li");
      li.textContent=`[${d.time}] ${d.user} â†’ ${d.action} ${d.target||""}`;
      auditList.appendChild(li);
    });
  });
}
</script>

</body>
</html>
